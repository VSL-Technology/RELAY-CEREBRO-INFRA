services:
  relay:
    build: .
    container_name: relay-real
    restart: unless-stopped

    env_file:
      - .env

    # 游녢 Compartilha a stack de rede do host (necess치rio para enxergar wg0)
    network_mode: host

    # 游댏 Permiss칫es necess치rias para WireGuard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    devices:
      - /dev/net/tun

    security_opt:
      - no-new-privileges:true
      - apparmor=unconfined

    # 游 Healthcheck interno
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

    # 游늵 Limite b치sico de mem칩ria
    deploy:
      resources:
        limits:
          memory: 512M

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.relay.rule=Host(`relay.3fconnet.cloud`)"
      - "traefik.http.routers.relay.entrypoints=websecure"
      - "traefik.http.routers.relay.tls.certresolver=le"
      - "traefik.http.services.relay.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.relay-sec.headers.sslRedirect=true"
      - "traefik.http.middlewares.relay-sec.headers.stsSeconds=31536000"
      - "traefik.http.routers.relay.middlewares=relay-sec@docker"
